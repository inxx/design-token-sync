name: Create PR for Design Token

on:
  repository_dispatch:
    types: [update-design-tokens]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: main

    - name: Set safe.directory
      run: |
        git config --global --add safe.directory /home/runner/work/design-token-sync/design-token-sync

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Check if branch exists and get changes
      id: check_branch
      run: |
        BRANCH_NAME="${{ github.event.client_payload.branch }}"
        echo "Checking branch: $BRANCH_NAME"
        
        # ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if git fetch origin $BRANCH_NAME; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
          
          # ë¸Œëœì¹˜ ê°„ ì°¨ì´ í™•ì¸
          CHANGED_FILES=$(git diff --name-only origin/main origin/$BRANCH_NAME)
          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes found in:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected between main and $BRANCH_NAME"
          fi
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
          echo "Branch $BRANCH_NAME not found"
        fi

    - name: Create Pull Request using GitHub CLI
      if: steps.check_branch.outputs.branch_exists == 'true' && steps.check_branch.outputs.has_changes == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="${{ github.event.client_payload.branch }}"
        
        # PR ìƒì„± (ë¼ë²¨ ì—†ì´)
        PR_URL=$(gh pr create \
          --title "ğŸ¨ ë””ìì¸ í† í° ìë™ ì—…ë°ì´íŠ¸" \
          --body "## ğŸ“‹ ë³€ê²½ì‚¬í•­
        ì—…ë¡œë“œëœ ë””ìì¸ í† í°ìœ¼ë¡œ ìë™ ìƒì„±ëœ PRì…ë‹ˆë‹¤.

        ### ğŸ“Š ìƒì„¸ì •ë³´
        - **íŠ¸ë¦¬ê±° ì‹œê°„**: ${{ github.event.client_payload.timestamp }}
        - **ë¸Œëœì¹˜**: ${{ github.event.client_payload.branch }}
        - **ë©”ì‹œì§€**: ${{ github.event.client_payload.message }}

        ### ğŸ”§ ë³€ê²½ëœ íŒŒì¼
        - \`style-dictionary/tokens.json\`: ìƒˆë¡œìš´ ë””ìì¸ í† í°
        - \`styles/variables.css\`: ìë™ ìƒì„±ëœ CSS ë³€ìˆ˜

        ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
        - [x] ë””ìì¸ í† í° JSON íŒŒì¼ ì—…ë°ì´íŠ¸
        - [x] CSS ë³€ìˆ˜ ìë™ ìƒì„± ì™„ë£Œ
        - [x] ë¹Œë“œ ê²€ì¦ ì™„ë£Œ

        ---
        ğŸ¤– ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." \
          --base main \
          --head $BRANCH_NAME)
        
        echo "âœ… PR ìƒì„± ì™„ë£Œ: $PR_URL"
        
        # ë¼ë²¨ ì¶”ê°€ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
        echo "ë¼ë²¨ ì¶”ê°€ ì‹œë„..."
        gh pr edit $PR_URL --add-label "design-tokens,auto-generated" || echo "âš ï¸ ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨ (ë¬´ì‹œ)"

    - name: Handle no changes case
      if: steps.check_branch.outputs.branch_exists == 'true' && steps.check_branch.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ PRì„ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
    - name: Handle missing branch case
      if: steps.check_branch.outputs.branch_exists == 'false'
      run: |
        echo "âŒ ë¸Œëœì¹˜ '${{ github.event.client_payload.branch }}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 